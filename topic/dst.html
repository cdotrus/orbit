<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dynamic Symbol Transformation - The Book of Orbit</title>


        <!-- Custom HTML head -->
        <style>
            dd {
                margin-bottom: 1em;
            }
        </style>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Book of Orbit</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dynamic-symbol-transformation"><a class="header" href="#dynamic-symbol-transformation">Dynamic Symbol Transformation</a></h1>
<p>This technique is related to <em>name mangling</em> in programming languages. <em>Name mangling</em> is a technique used to solve problems regarding the need to resolve unique names for programming entities. You can learn more about name mangling <a href="https://en.wikipedia.org/wiki/Name_mangling">here</a>.</p>
<h2 id="problem"><a class="header" href="#problem">Problem</a></h2>
<p>Before we begin, it is important to understand the problem we are trying to solve. An issue inherent to VHDL, Verilog, SystemVerilog, and many other languages is <em>namespace pollution</em>, which is when a large number of programming language variables/identifiers/units/classes are defined at the global level. To learn more about namespace pollution, <a href="https://stackoverflow.com/questions/8862665/what-does-it-mean-global-namespace-would-be-polluted/13352212">here</a> is a StackOverflow post that explains it in relation to Javascript.</p>
<p>Namespace pollution can lead to <em>namespace clashes</em>. As you define more primary design units at the same scope, you are more likely to have two things that accidently have the same name. This is at the core the problem we are going to solve, because HDL compilers and synthesizers are not built to gracefully handle clashes and will error out when a primary design unit at the same scope has multiple definitions.</p>
<p>In VHDL/Verilog, a common example of a namespace clash is when different files define an entity/module by the same name, which may have different behaviors. Namespace clashes may start to appear when a higher-level ip requires the same entity/module from an ip but as different versions throughout its dependency tree.</p>
<h2 id="solution"><a class="header" href="#solution">Solution</a></h2>
<p>We solve the namespace pollution problem with an algorithm called <em>dynamic symbol transformation</em> (DST). The DST algorithm solves the namespace clashing problem by rewriting conflicts with a new unique identifier without losing information in the original identifier.</p>
<h3 id="limitations"><a class="header" href="#limitations">Limitations</a></h3>
<p>Orbit automatically handles resolving duplicate identifiers for primary design units due to two design contraints. The limitations are:</p>
<ol>
<li>All primary design unit identifiers in the current ip must be unique within the scope of the ip.</li>
<li>All primary design units identifiers in the current ip must be unique within the scope of the ip's direct dependencies. An identifier can be duplicated for primary design units across indirect dependencies.</li>
</ol>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>This section walks through a basic demonstration of the DST algorithm. First, it defines some terminology, and then walks through the algorithm's functionality.</p>
<h3 id="symbols"><a class="header" href="#symbols">Symbols</a></h3>
<p>Within the context of VHDL, let's consider a <em>symbol</em> to be the identifier of a <em>primary design unit</em>. A primary design unit is a VHDL construct that exists at the global namespace. There are four primary design units:</p>
<ul>
<li>entity</li>
<li>package</li>
<li>configuration</li>
<li>context</li>
</ul>
<blockquote>
<p><strong>Note:</strong> VHDL does support the concept of <em>libraries</em>, which can add 1 level of nested scope to a primary design unit, but this implementation only pushes the namespace clashing problem back 1 level.</p>
</blockquote>
<p>Within the context of Verilog/SystemVerilog, let's consider a <em>symbol</em> to be the identifier of a <em>design element</em>. A design element is a Verilog/SystemVerilog construct that exists at the global namespace. For Verilog, there is only two design elements (module and primitive), but for SystemVerilog, there are seven design elements:</p>
<ul>
<li>module</li>
<li>program</li>
<li>interface</li>
<li>checker</li>
<li>package</li>
<li>primitive</li>
<li>configuration</li>
</ul>
<p>In the following code, the symbol <code>nand_g</code> corresponds to a module.</p>
<p>Filename: lab1/nand_g.v</p>
<pre><code class="language-verilog">module nand_g (
  input wire a, 
  input wire b,
  output wire c
);
</code></pre>
<p>Remember that this identifier could appear again at the same namespace level (since its global across all source code files), even if it has a different interface/implementation.</p>
<p>Now imagine you are integrating HDL code from various existing ips. As you instantiate modules within larger modules, you realize there exists another module named <code>nand_g</code> in the hierarchy, but this one has a different behavior and port interface than the previously defined <code>nand_g</code> circuit from the "lab1/" directory.</p>
<p>Filename: lab3/nand_g.v</p>
<pre><code class="language-verilog">module nand_g (
  input wire[3:0] x,
  input wire[3:0] y,
  output wire[3:0] z
);
</code></pre>
<p>Since the current ip requires both code segments, then traditionally your EDA tool would complain to you and be unable to resolve which <code>nand_g</code> to be used where. It then falls on the developer to rename one of the modules where it is defined and everywhere it is referenced, which introduces additional overhead in time and possibilities for errors. This problem is solved with DST.</p>
<h3 id="setup"><a class="header" href="#setup">Setup</a></h3>
<p>Consider the following project-level ip dependency tree:</p>
<p><img src="./../images/dst-graph1.svg" alt="" /></p>
<p>The gray node (<code>final-project</code>) is the local ip you are currently working within, the green nodes (<code>lab2</code>, <code>lab3</code>) are the direct dependencies to the local ip, and the blue node (<code>lab1</code>) is an indirect dependency to the local ip.</p>
<p>Within each project, there exists one or more HDL source code files describing design units.</p>
<p>Imagine the <code>final-project</code> ip has a module called <code>half_add</code> which is the root of circuit hierarchy. From there, it reuses entities from the other ip.</p>
<p>Consider then HDL-level dependency tree:</p>
<p><img src="./../images/dst-graph2.svg" alt="" /></p>
<p>Notice lab1 and lab3 both have the <code>nand_g</code> module, but their interfaces and functionality are different as previously mentioned. How can we allow both units in the hierarchy while resolving the namespace clash?</p>
<h3 id="transformation"><a class="header" href="#transformation">Transformation</a></h3>
<p>DST identifies namespace clashes within the current dependency graph and automatically resolve the conflicts to produce a clean unambiguous graph.</p>
<p><img src="./../images/dst-graph3.svg" alt="" /></p>
<p>The yellow nodes (<code>lab2</code>, <code>lab1</code>) are the ips that had their source code modified due to DST. Since the modified contents of these ips no longer matches their original contents, the modifications are stored as separate entries in the catalog's cache apart from their original entries.</p>
<p>The red node (<code>nand_g.v</code>) is the HDL design element that must be dynamically renamed due to the namespace clash for <code>nand_g</code>. The identifier <code>nand_g</code> in lab1 was appended with the first 10 digits of the original ip's checksum (<code>fbe4720d0</code>). This transforms lab1's <code>nand_g</code> module into <code>nand_g_fbe4720d0</code>, which is unique and no longer clashes with <code>nand_g</code> in lab3.</p>
<blockquote>
<p><strong>Note:</strong> DST specifically chose to <em>not</em> rename the <code>nand_g</code> from lab3. If had decided to rename the <code>nand_g</code> from lab3, the user would be burdened with tracking and maintaining the new renamed unique identifier in the local ip (final-project). Since DST never renames identifiers in direct dependencies, DST is always abstracted away from the user and has zero overhead. While direct dependencies may be modified due to neigboring an ip that undergoes DST, direct dependencies are never chosen for DST.</p>
</blockquote>
<p>The orange nodes (<code>and_g.v</code>, <code>xor_g.v</code>) are the HDL design elements that reference/instantiate the design element that was marked for symbol transformation. Once the ip targeted for DST (lab1) resolves the namespace clash, we must update the references for this design element in all the upstream neighboring ips (lab2). Since their references are now broken due to <code>nand_g</code> being renamed to <code>nand_g_fbe4720d0</code>, the source code is analyzed and updated to fix the broken references of <code>nand_g</code> to <code>nand_g_fbe4720d0</code>.</p>
<p>The final unambiguous HDL-level dependency graph is the following:</p>
<pre><code>half_add (final-project)
├─ nand_g (lab3)
│  ├─ not_g (lab2)
│  └─ and_g (lab2)*
|     └─ nand_g_fbe4720d0 (lab1)*
└─ xor_g (lab2)*
   └─ nand_g_fbe4720d0 (lab1)*
</code></pre>
<p>The <code>*</code> indicates the modules that had their source code modified to either rename the namespace collision or update its references to the new renamed identifier.</p>
<h3 id="summary"><a class="header" href="#summary">Summary</a></h3>
<p>To recap, DST handled the namespace clash by <em>transforming</em>, or renaming, the module <code>nand_g</code> within lab1. The <code>nand_g</code> identifier was appended with the first 10 digits of the original lab1 ip's checksum (fbe4720d0) to make it <code>nand_g_fbe4720d0</code>. This transformation occurred at that ip's source code level (lab1), and modifications were made to the source code for all dependent neighbors of lab1, which was only lab2 in this example. The source code in lab2 had to be updated to rename the references that were originally <code>nand_g</code> to <code>nand_g_fbe4720d0</code>. Each ip that had source code modifications have their changes saved to their own entries in the catalog's cache, such that the original entries are still intact and available for future use.</p>
<h2 id="emphasis"><a class="header" href="#emphasis">Emphasis</a></h2>
<p>Dynamic symbol transformation lets Orbit avoid the major issues and frustrations of package management that stem from dependency incompatibility. As projects grow in complexity and the number of dependencies increases, Orbit can continue to allow users to integrate different verisons of the same package throughout the overall design while retaining dependency compatibility. Conflicts in incompatible versions are avoided within the dependency graph through DST. You can learn more about dependency incompatibility <a href="https://en.wikipedia.org/wiki/Dependency_hell">here</a>.</p>
<h2 id="further-reading"><a class="header" href="#further-reading">Further Reading</a></h2>
<ul>
<li>https://stephencoakley.com/2019/04/24/how-rust-solved-dependency-hell</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../topic/swapping.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../reference/reference.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../topic/swapping.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../reference/reference.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
